<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>استوری از {{ story.user.username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { margin: 0; background-color: #1a1a1a; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        .story-container { position: relative; width: 100%; max-width: 400px; height: 95vh; max-height: 800px; background: #000; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .story-header { position: absolute; top: 0; left: 0; right: 0; padding: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0)); z-index: 2; }
        .progress-bar-container { width: 100%; height: 2px; background-color: rgba(255, 255, 255, 0.4); border-radius: 2px; }
        .progress-bar { height: 100%; background-color: #fff; animation: progress 8s linear forwards; }
        @keyframes progress { from { width: 0%; } to { width: 100%; } }
        .user-info { display: flex; align-items: center; color: white; margin-top: 10px; }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; margin-left: 10px; }
        .story-image { width: 100%; height: 100%; object-fit: cover; }
        .story-footer { position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; display: flex; align-items: center; z-index: 2; }
        .story-footer .left-section { flex-grow: 1; }
        .story-footer .right-section { display: flex; align-items: center; }
        .story-footer form { display: flex; }
        .story-footer input { width: 100%; background: transparent; border: 1px solid #fff; border-radius: 20px; padding: 8px 15px; color: #fff; }
        .story-footer input::placeholder { color: #ccc; }
        .story-footer button { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        .close-btn { position: absolute; top: 20px; left: 20px; color: white; font-size: 30px; text-decoration: none; z-index: 3; }
        .comments-overlay { position: absolute; bottom: 70px; left: 15px; right: 15px; color: white; text-shadow: 1px 1px 2px black; max-height: 150px; overflow-y: auto; z-index: 2; }
        .comment { font-size: 14px; }
        .likes-count, .viewers-count { color: white; font-weight: bold; font-size: 14px; text-decoration: none; margin-right: 15px; }
        .modal-content { background-color: #282828; color: #fff; }
        .modal-header { border-bottom: 1px solid #444; }
    </style>
</head>
<body>
    <a href="{% url 'shop1:home' %}" class="close-btn">&times;</a>
    <div class="story-container">
        <div class="story-header">
            <div class="progress-bar-container"><div class="progress-bar"></div></div>
            <div class="user-info">
                {% if story.user.profile.image %}
                <img src="{{ story.user.profile.image.url }}">
                {% endif %}
                <strong>{{ story.user.username }}</strong>
            </div>
        </div>

        <img src="{{ story.image.url }}" class="story-image" alt="Story by {{ story.user.username }}">

        <div class="comments-overlay">
            {% for comment in comments %}
                <p class="comment"><strong>{{ comment.user.username }}:</strong> {{ comment.body }}</p>
            {% endfor %}
        </div>
        
        <div class="story-footer">
            <div class="left-section">
                {% if story.user == request.user %}
                    <a href="#" class="viewers-count" data-bs-toggle="modal" data-bs-target="#viewersModal">
                        <i class="bi bi-eye"></i>
                        {{ story.total_views }}
                    </a>
                {% endif %}
            </div>
            <div class="right-section">
                <form action="{% url 'shop1:add_story_comment' story.id %}" method="post" class="me-2">
                    {% csrf_token %}
                    <input type="text" name="body" placeholder="ارسال پیام..." required>
                </form>
                <form action="{% url 'shop1:like_story' story.id %}" method="post" class="flex-grow-0">
                     {% csrf_token %}
                    <button type="submit"><i class="bi bi-heart"></i></button>
                </form>
                {% if story.user == request.user %}
                    <a href="#" class="likes-count" data-bs-toggle="modal" data-bs-target="#likersModal">
                        {{ story.total_likes }}
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    {% if story.user == request.user %}
    <div class="modal fade" id="likersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"><div class="modal-header"><h5 class="modal-title">لایک‌ها</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    {% for liker in story.likes.all %}<p>{{ liker.username }}</p>{% empty %}<p>بدون لایک.</p>{% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="viewersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"><div class="modal-header"><h5 class="modal-title">بازدیدها</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    {% for viewer in story.viewers.all %}<p>{{ viewer.username }}</p>{% empty %}<p>بدون بازدید.</p>{% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        setTimeout(() => window.location.href = "{% url 'shop1:home' %}", 8000);
    </script>
</body>
</html>