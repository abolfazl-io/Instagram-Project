{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row align-items-center">
        <div class="col-md-4 text-center">
            {% if profile.image %}
                <img src="{{ profile.image.url }}" class="rounded-circle" width="150" height="150" style="object-fit: cover;" alt="Profile image">
            {% else %}
                <i class="bi bi-person-circle" style="font-size: 150px;"></i>
            {% endif %}
        </div>
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-3">
                <h2 class="me-3">{{ profile.user.username }}</h2>
                
                {% if user.is_authenticated and user != profile.user %}
                    <button id="follow-btn" class="btn {% if is_following %}btn-light border{% else %}btn-primary{% endif %}" data-username="{{ profile.user.username }}" data-url="{% url 'shop1:follow_unfollow' profile.user.username %}">
                        {% if is_following %}Unfollow{% else %}Follow{% endif %}
                    </button>
                    <a href="{% url 'shop1:create_thread' profile.user.username %}" class="btn btn-light border ms-2">پیام</a>
                {% endif %}
                </div>
            <div class="d-flex mb-3">
                <div class="me-4"><strong>{{ posts_count }}</strong> پست</div>
                <a href="{% url 'shop1:followers_list' username=profile.user.username %}" class="text-dark text-decoration-none me-4">
                    <strong id="followers-count">{{ followers_count }}</strong> دنبال‌کننده
                </a>
                <a href="{% url 'shop1:following_list' username=profile.user.username %}" class="text-dark text-decoration-none">
                    <strong>{{ following_count }}</strong> دنبال‌شونده
                </a>
            </div>
            <div>
                <strong>{{ profile.first_name }} {{ profile.last_name }}</strong>
                <p>{{ profile.bio }}</p>
            </div>
        </div>
    </div>
    <hr>
    <div class="row row-cols-3 g-3">
        {% for post in posts %}
        <div class="col">
            <a href="{% url 'shop1:post_detail' post.pk %}">
                {% if post.media.first %}
                <img src="{{ post.media.first.file.url }}" class="img-fluid" alt="{{ post.title }}" style="aspect-ratio: 1/1; object-fit: cover;">
                {% endif %}
            </a>
        </div>
        {% empty %}
        <p class="text-center w-100">این کاربر هنوز پستی منتشر نکرده است.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const followBtn = document.getElementById('follow-btn');
    if (followBtn) {
        followBtn.addEventListener('click', function() {
            const url = this.dataset.url;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                const followersCountEl = document.getElementById('followers-count');
                followersCountEl.textContent = data.followers_count;

                if (data.is_following) {
                    this.textContent = 'Unfollow';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-light', 'border');
                } else {
                    this.textContent = 'Follow';
                    this.classList.remove('btn-light', 'border');
                    this.classList.add('btn-primary');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
});
</script>
{% endblock page_scripts %}