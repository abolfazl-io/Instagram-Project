{% extends 'base.html' %}
{% block title %}دایرکت{% endblock %}

{% block content %}
<div class="card" style="height: 80vh;">
    <div class="row g-0 h-100">
        <div class="col-4 border-end h-100 d-flex flex-column">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ user.username }}</h5>
                <a href="{% url 'shop1:create_group' %}" class="btn btn-sm btn-light">
                    <i class="bi bi-pencil-square fs-5"></i>
                </a>
            </div>
            <div class="flex-grow-1" style="overflow-y: auto;">
                {% for thread in threads %}
                <a href="{% url 'shop1:thread_view' thread.id %}" class="text-decoration-none text-dark">
                    <div class="d-flex align-items-center p-3 inbox-item border-bottom">
                    {% if thread.name %}
                            <div class="position-relative me-3" style="width: 56px; height: 56px;">
                                {% with thread.participants.all|slice:"1:3" as participants_sample %}
                                    {% if participants_sample.0 and participants_sample.0.profile.image %}
                                        <img src="{{ participants_sample.0.profile.image.url }}" class="rounded-circle" width="40" height="40" style="position: absolute; top: 0; left: 15px; border: 2px solid white; object-fit: cover;">
                                    {% else %}
                                        <i class="bi bi-person-circle fs-1 text-secondary" style="position: absolute; top: 0; left: 15px;"></i>
                                    {% endif %}
                                    {% if participants_sample.1 and participants_sample.1.profile.image %}
                                        <img src="{{ participants_sample.1.profile.image.url }}" class="rounded-circle" width="40" height="40" style="position: relative; border: 2px solid white; object-fit: cover;">
                                    {% else %}
                                        <i class="bi bi-person-circle fs-1 text-secondary" style="position: relative;"></i>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        {% else %}
                            {% for participant in thread.participants.all %}
                                {% if participant != request.user %}
                                    {% if participant.profile.image %}
                                        <img src="{{ participant.profile.image.url }}" class="rounded-circle me-3" width="56" height="56" style="object-fit: cover;">
                                    {% else %}
                                        <i class="bi bi-person-circle me-3 text-secondary" style="font-size: 56px;"></i>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        
                        <div>
                            <p class="fw-bold mb-0">
                                {% if thread.name %}
                                    {{ thread.name }}
                                {% else %}
                                    {% for user_p in thread.participants.all %}{% if user_p != request.user %}{{ user_p.username }}{% endif %}{% endfor %}
                                {% endif %}
                            </p>
                            {% if thread.messages.last %}
                                <small class="text-muted">
                                    <strong>{{ thread.messages.last.sender.username }}:</strong>
                                    {{ thread.messages.last.body|default_if_none:"فایل"|truncatechars:20 }}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <p class="text-muted p-3">شما هنوز هیچ مکالمه‌ای ندارید.</p>
                {% endfor %}
            </div>
        </div>
        <div class="col-8 h-100 d-flex flex-column justify-content-center align-items-center">
             <i class="bi bi-send" style="font-size: 60px;"></i>
            <h4 class="mt-3">پیام‌های شما</h4>
            <p class="text-muted">یک چت را برای مشاهده پیام‌ها انتخاب کنید.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<style>
    main.container {
        max-width: 935px !important;
    }
    .inbox-item:hover {
        background-color: #f1f1f1;
    }
    .dark-mode .inbox-item:hover {
        background-color: #2c2c2c;
    }
</style>
{% endblock %}